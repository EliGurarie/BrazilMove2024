---
title: 'Home Range Analyses: Minimum Convex Polygon'
author: "Nicki Barbour and Elie Gurarie"
subtitle: "[Brazil Move 2024 - UFMS - Campo Grande](https://eligurarie.github.io/BrazilMove2024)"
date: "May 23, 2024"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Goal

> To estimate home ranges with Minimum Convex Polygons and Kernel Density Estimates. 

Packages:

```{r}
library(ggplot2)
library(plyr)
library(sf)
library(adehabitatHR)
library(mapview)
```


# Selecting some animals

```{r loadData, echo = -1}
setwd("../")
load("./data/elk_processed.rda")
head(elk_gps)
```

We've picked out 3 individuals that are, largely, non-migratory but resident - and also add some X-Y coordinates:

```{r SelectResidentElk}
elk_res <- elk_gps |>
  subset(id %in% c("YL80", "YL91", "YL94")) |>
  mutate(id = droplevels(id))

elk_res_sf <- elk_res |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326) |> 
  st_transform(32611) 

elk_res <- cbind(elk_res, st_coordinates(elk_res_sf))
str(elk_res)
```

## Visualize Tracks

Let's start off by visualizing our selected tracks, using some of the methods we learned in lab 1.  We can see that these tracks have a nice "blob" of movement, indicating residential behavior suitable for home range analysis. 


```{r ThreeElkMapped}
ggplot(data=elk_res, aes(x=X, y=Y, col = id)) +
  geom_path() + coord_fixed() + ggtitle("Some (mostly) resident elk")
```

These are *generally* resident animals, with a LOT of overlap, but also, clearly, some long-distance movements. 

Here's a mapview:

```{r mapviewElkTracks}
require(dplyr)
elk_tracks <- elk_res_sf |> 
  group_by(id) |> 
  summarize(do_union=FALSE) |> 
  st_cast("LINESTRING")

mapview(elk_tracks,zcol="id")
```

# Minimum Convex Polygon

You can get minimum convex polygons using the `adehabitatHR` package, which has many useful functions for homerange analysis. 

The MCP method is very simple - essentially, it draws the smallest/tightest polygon around the locations, by 1) calculating the centroid of all the points, 2) calculating the distance from each location/point to this centroid, 3) removing all points that have a distance greater than a specified quantile (usually 95-100 percent) and 4) applying the "convex hull" algorithm to determine the minimum convex polygon for the points. 

You can learn more about homerange analysis with this package with the [adehabitat HR vignette](https://cran.r-project.org/web/packages/adehabitatHR/vignettes/adehabitatHR.pdf).

```{r}
library(adehabitatHR)
```

The `mcp` function from adehabitatHR works on one individual at a time. It also requires that the data first be converted to a "SpatialPoints" structure, a different spatial data type (similar to sf, but using the "sp" package instead).

This function also requires that the user specify the quantile to use for selecting locations for the MCP method - generally 95-100%. 

In order to perform our homerange analysis on all of our individuals at once, it will be useful to write a function that takes an individual sf object and a parameter for the percent of points to use for MCP calcuation. The function will return an MCP object, from the `mcp` function. 

We'll start with one animal, and convert it to an `sp` object.

```{r}
myelk_sf <- elk_res_sf |> subset(id == "YL94")
myelk_sp <- myelk_sf |> as_Spatial()
```

And the `mcp` functions returns the MCP.  You can provide the "percentage" which will exclude some points.  Just running the function outputs an area (in square km, but that can be adjusted as needed):

```{r mcp95}
(mcp95 <- mcp(myelk_sp, percent = 95, unout = "km2"))
```


```{r mcp100}
(mcp100 <- mcp(myelk_sp, percent = 100, unout = "km2"))
```

Note that the 100% MCP is much larger than the 95% MCP - we'll see exactly why soon.  

You can easily convert this mcp to a simple feature: 

```{r}
mcp95 <- st_as_sf(mcp95)
mcp100 <- st_as_sf(mcp100)

ggplot() + 
  geom_sf(data = mcp100, color = "blue", fill = alpha("blue",.2)) +
    geom_sf(data = mcp95, color = "red", fill = alpha("red",.2)) + 
     geom_sf(data = myelk_sf, alpha = 0.2)
```

 
```{r findMCPFunction}
findMCP <- function(id_sf, percent){
  id_sp <- id_sf |> as_Spatial()
  id_mcp <- mcp(id_sp, percent, unout="km2")
  return(st_as_sf(id_mcp))
}
findMCP(elk_res_sf |> subset(id == "YL80"), 95)
findMCP(elk_res_sf |> subset(id == "YL91"), 95)
findMCP(elk_res_sf |> subset(id == "YL94"), 95)
```
You can collect a bunch of simple features into a `SpatialPointsDataframe` and get all the MCP's at once.  Importantly - however - the data can ONLY contain one column - for the ID's. 

```{r}
elk_sp <- elk_res_sf |> mutate(datetime = NULL) |> as_Spatial(IDs = "id") 
elk_mcps <- mcp(elk_sp, percent = 95, unout = "km2") |> st_as_sf()
mapview(elk_mcps, zcol = "id")
```

>  Are these a good description of the home range?  What problems are there? 
 
